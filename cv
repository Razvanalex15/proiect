<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoBazar Chat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="left">
    <div class="side-header">
      <h3>AutoBazar</h3>
      <span>inbox â€¢ mesaje</span>
    </div>

    <input class="search" type="search" placeholder="CautÄƒ conversaÈ›ie" />

    <!-- conversation: BMW -->
    <div class="chat-item active" data-room="bmw-320d" role="button" tabindex="0">
      <b>BMW 320d â€¢ VÃ¢nzÄƒtor</b>
      <span>â€Mai e disponibilÄƒ?â€</span>
    </div>

    <!-- conversation: Golf -->
    <div class="chat-item" data-room="golf-7" role="button" tabindex="0">
      <b>Golf 7 â€¢ CumpÄƒrÄƒtor</b>
      <span>Ok, trimit poze ğŸ‘</span>
    </div>
  </aside>

  <!-- CHAT -->
  <main class="chat">

    <header class="top">
      <div>
        <b>Asistent AutoBazar</b>
        <small class="status">
          <span class="dot"></span> activ acum
        </small>
      </div>
    </header>

    <!-- MESSAGES (JS renders here) -->
    <section class="msgs" id="msgs" aria-label="Mesaje">
      <!-- LasÄƒ gol. JS va popula mesajele. -->
    </section>

    <!-- INPUT BAR -->
    <footer class="bar">
      <button class="ico" type="button" title="AtaÈ™eazÄƒ" aria-label="AtaÈ™eazÄƒ">â•</button>
      <button class="ico" type="button" title="Emoji" aria-label="Emoji">ğŸ˜Š</button>

      <input
        class="in"
        id="messageInput"
        type="text"
        placeholder="Scrie un mesaj"
        autocomplete="off"
        aria-label="Mesaj"
      />

      <button class="ico" type="button" title="Voice" aria-label="Voice">ğŸ¤</button>
      <button class="send" id="sendBtn" type="button" title="Trimite" aria-label="Trimite">â¤</button>
    </footer>

  </main>

</div>

<!-- Socket.IO client (required for realtime). Keep before client.js -->
<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script src="client.js"></script>
</body>
</html>























(() => {
  "use strict";

  class PubSub {
    constructor() {
      this.subscriptions = new Map();
    }

    subscribe(name, fn) {
      const list = this.subscriptions.get(name) || [];
      list.push(fn);
      this.subscriptions.set(name, list);

      return () => {
        const cur = this.subscriptions.get(name) || [];
        this.subscriptions.set(name, cur.filter((x) => x !== fn));
      };
    }

    publish(name, data) {
      const list = this.subscriptions.get(name);
      if (!list) return;
      list.forEach((fn) => fn(data));
    }
  }

  class ServerConnection extends PubSub {
    constructor({ url, room, userId }) {
      super();
      this.url = url;
      this.room = room;
      this.userId = userId;

      if (typeof io === "undefined") {
        throw new Error(
          'Socket.IO client not found. Add: <script src="http://localhost:3000/socket.io/socket.io.js"></script> before client.js'
        );
      }

      this.socket = io(this.url);

      this.socket.on("connect", () => {
        this.publish("status", { type: "connected", id: this.socket.id });
        this.joinRoom(this.room);
      });

      this.socket.on("disconnect", () => {
        this.publish("status", { type: "disconnected" });
      });

      this.socket.on("chat:message", (msg) => {
        this.publish("message", msg);
      });

      this.socket.on("chat:system", (msg) => {
        this.publish("system", msg);
      });
    }

    joinRoom(room) {
      this.room = room;
      this.socket.emit("chat:join", { room, userId: this.userId });
    }

    leaveRoom(room) {
      this.socket.emit("chat:leave", { room, userId: this.userId });
    }

    send(text) {
      const msg = {
        room: this.room,
        userId: this.userId,
        text,
        ts: Date.now(),
      };
      this.socket.emit("chat:message", msg);
    }
  }

  class ChatUI extends PubSub {
    constructor() {
      super();

      this.msgs = document.getElementById("msgs");
      this.input = document.getElementById("messageInput");
      this.sendBtn = document.getElementById("sendBtn");

      if (!this.msgs || !this.input || !this.sendBtn) {
        throw new Error(
          "Missing DOM elements. Ensure you have: <section id='msgs'>, <input id='messageInput'>, <button id='sendBtn'>"
        );
      }

      this.onSendClick = this.onSendClick.bind(this);
      this.onKeyDown = this.onKeyDown.bind(this);

      this.sendBtn.addEventListener("click", this.onSendClick);
      this.input.addEventListener("keydown", this.onKeyDown);
    }

    onKeyDown(e) {
      if (e.key === "Enter") this.onSendClick();
    }

    onSendClick() {
      const text = this.input.value.trim();
      if (!text) return;

      this.publish("send", { text });

      this.input.value = "";
      this.input.focus();
    }

    clearMessages() {
      this.msgs.innerHTML = "";
    }

    addMessage({ side, text }) {
      const div = document.createElement("div");
      div.className = side === "right" ? "msg right" : "msg left";
      div.textContent = text;
      this.msgs.appendChild(div);
      this.msgs.scrollTop = this.msgs.scrollHeight;
    }
  }

  class ChatApp {
    constructor() {
      this.ui = new ChatUI();

      this.userId = this.getOrAskUserId();

      this.room = this.getActiveRoom();

      this.connection = new ServerConnection({
        url: "http://localhost:3000",
        room: this.room,
        userId: this.userId,
      });

      this.store = new Map();

      this.ui.subscribe("send", ({ text }) => {

        this.connection.send(text);
      });

      this.connection.subscribe("message", (msg) => {
        this.saveMessage(msg.room, msg);

        if (msg.room !== this.room) {
          return;
        }

        const side = msg.userId === this.userId ? "right" : "left";
        this.ui.addMessage({ side, text: msg.text });
      });

      this.connection.subscribe("system", (msg) => {
        if (msg.room !== this.room) return;
        this.ui.addMessage({ side: "left", text: `â„¹ï¸ ${msg.text}` });
      });

      document.querySelectorAll(".chat-item").forEach((item) => {
        item.addEventListener("click", () => {
          const newRoom = item.dataset.room;
          if (!newRoom || newRoom === this.room) return;

          document
            .querySelectorAll(".chat-item")
            .forEach((x) => x.classList.remove("active"));
          item.classList.add("active");

          this.connection.leaveRoom(this.room);
          this.room = newRoom;
          this.connection.joinRoom(this.room);

          this.renderRoom(this.room);
        });
      });

      this.renderRoom(this.room);

      if ((this.store.get(this.room) || []).length === 0) {
        this.ui.addMessage({
          side: "left",
          text: "Salut! ğŸ‘‹ Scrie un mesaj ca sÄƒ Ã®ncepi conversaÈ›ia.",
        });
      }
    }

    getActiveRoom() {
      const active = document.querySelector(".chat-item.active");
      return active?.dataset.room || "bmw-320d";
    }

    getOrAskUserId() {
      const key = "autobazar_userId";
      let id = localStorage.getItem(key);

      if (!id) {
        id = prompt("User ID? (ex: user1, user2)") || "user";
        id = id.trim() || "user";
        localStorage.setItem(key, id);
      }

      return id;
    }

    saveMessage(room, msg) {
      if (!this.store.has(room)) this.store.set(room, []);
      this.store.get(room).push(msg);
    }

    renderRoom(room) {
      this.ui.clearMessages();
      const msgs = this.store.get(room) || [];
      msgs.forEach((m) => {
        const side = m.userId === this.userId ? "right" : "left";
        this.ui.addMessage({ side, text: m.text });
      });
    }
  }

  new ChatApp();
})();





















const http = require("http");
const { Server } = require("socket.io");

const server = http.createServer();

const io = new Server(server, {
  cors: { origin: "*" }, // Live Server
});

io.on("connection", (socket) => {
  console.log("connected", socket.id);

  socket.on("chat:join", ({ room, userId }) => {
    socket.join(room);
    console.log(`${userId} joined ${room}`);
  });

  socket.on("chat:message", (msg) => {
    // IMPORTANT: trimite la TOTI din room, inclusiv la cel care a trimis
    io.to(msg.room).emit("chat:message", msg);
  });

  socket.on("disconnect", () => {
    console.log("disconnected", socket.id);
  });
});

server.listen(3000, () => {
  console.log("Socket.IO server running on http://localhost:3000");
});
